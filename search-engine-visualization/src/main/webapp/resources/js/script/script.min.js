var ns=ns||{};ns.sev=ns.sev||{};ns.sev.currentPage=1;ns.sev.serpsPerPage=10;ns.sev.clusteredSerpList=[];ns.sev.css=ns.sev.css||{};ns.sev.css.tabWordCloud="li#tab-word-cloud";ns.sev.css.tabTree="li#tab-tree";ns.sev.css.tabRadialTree="li#tab-radial-tree";ns.sev.css.tabForceGraph="li#tab-force-graph";ns.sev.css.tabForceSearchGraph="li#tab-force-search-graph";ns.sev.css.tabForceClusterNodes="li#tab-force-cluster-nodes";ns.sev.css.tabDropdown="li#tab-dropdown-cluster-algo";ns.sev.css.tabLingo="li#tab-lingo";
ns.sev.css.tabStc="li#tab-stc";ns.sev.css.tabKmeans="li#tab-kmeans";ns.sev.solr={};ns.sev.solr.qt="/clustering";ns.sev.solr.wt="wt=json";ns.sev.solr.facet="facet=true&facet.field=text_facet";ns.sev.solr.ClusteringEngineLingo="clustering.engine=lingo";ns.sev.solr.ClusteringEngineStc="clustering.engine=stc";ns.sev.solr.ClusteringEngineKmeans="clustering.engine=kmeans";ns.sev.solr.urlLocal="http://localhost:5000/sevCore";ns.sev.solr.urlHeroku="https://solr-clustering.herokuapp.com/sevCore";
ns.sev.solr.url=ns.sev.solr.urlLocal;ns.sev.solr.query=ns.sev.solr.url+ns.sev.solr.qt+"?"+ns.sev.solr.wt+"&"+ns.sev.solr.facet;ns.sev.resultSolrJSON={};ns.sev.resultSolrClusteringLingoJSON={};ns.sev.resultSolrClusteringStcJSON={};ns.sev.resultSolrClusteringKmeansJSON={};ns.sev.resultSolrSelectJSON={};ns.sev.resultClusterTreeJSON={};ns.sev.resultLinksNodesForceJSON={};ns.sev.resultClusterNodesJSON={};ns.sev.resultFacetingJSON={};
ns.sev.loadScript=function(){ns.sev.ajaxSolrClustering();ns.sev.setQueryStringBold(document.getElementById("input-query").value,"hilitor");$("#loadButton").click(function(b){ns.sev.loadNextPageClient(b,ns.sev.resultSolrJSON)})};
ns.sev.afterAJAX=function(){ns.sev.getWordCloud();$(ns.sev.css.tabWordCloud).click(function(){$("div#word-cloud svg").remove();ns.sev.getWordCloud()});$(ns.sev.css.tabTree).click(function(){$("div#draw-tree svg").remove();ns.sev.getTree()});$(ns.sev.css.tabRadialTree).click(function(){$("div#draw-radial-tree svg").remove();ns.sev.getRadialTree()});$(ns.sev.css.tabForceGraph).click(function(){$("div#draw-force-graph svg").remove();ns.sev.getForceGraph()});$(ns.sev.css.tabForceSearchGraph).click(function(){$("div#draw-force-search-graph svg").remove();
ns.sev.getForceSearchGraph()});$(ns.sev.css.tabForceClusterNodes).click(function(){$("div#draw-force-cluster-nodes svg").remove();ns.sev.getForceClusterNodes()});ns.sev.responsiveD3();ns.sev.setDropdownClusteringAlgorithm()};ns.sev.getWordCloud=function(){ns.sev.resultFacetingJSON=ns.sev.getFacetingJSON(ns.sev.resultSolrJSON);ns.sev.drawD3WordCloud(ns.sev.resultFacetingJSON);ns.sev.refreshSerps(ns.sev.resultSolrJSON)};
ns.sev.getTree=function(){ns.sev.resultClusterTreeJSON=ns.sev.getClusterTreeJSON(ns.sev.resultSolrJSON);ns.sev.drawD3Tree(ns.sev.resultClusterTreeJSON);ns.sev.refreshSerps(ns.sev.resultSolrJSON)};ns.sev.getRadialTree=function(){ns.sev.resultClusterTreeJSON=ns.sev.getClusterTreeJSON(ns.sev.resultSolrJSON);ns.sev.drawD3TreeRadial(ns.sev.resultClusterTreeJSON);ns.sev.refreshSerps(ns.sev.resultSolrJSON)};
ns.sev.getForceGraph=function(){ns.sev.resultLinksNodesForceJSON=ns.sev.getLinksNodesForceJSON(ns.sev.resultSolrJSON);ns.sev.drawD3ForceGraph(ns.sev.resultLinksNodesForceJSON);ns.sev.refreshSerps(ns.sev.resultSolrJSON)};ns.sev.getForceSearchGraph=function(){ns.sev.resultClusterTreeJSON=ns.sev.getClusterTreeJSON(ns.sev.resultSolrJSON);ns.sev.drawD3ForceSearchGraph(ns.sev.resultClusterTreeJSON);ns.sev.refreshSerps(ns.sev.resultSolrJSON)};
ns.sev.getForceClusterNodes=function(){ns.sev.resultClusterNodesJSON=ns.sev.getClusterNodesJSON(ns.sev.resultSolrJSON);ns.sev.drawD3ForceClusterNodes(ns.sev.resultClusterNodesJSON);ns.sev.refreshSerps(ns.sev.resultSolrJSON)};
ns.sev.setDropdownClusteringAlgorithm=function(){$(ns.sev.css.tabLingo).click(function(){ns.sev.resultSolrJSON=ns.sev.resultSolrClusteringLingoJSON;$(ns.sev.css.tabLingo).attr("class","active");$(ns.sev.css.tabStc).attr("class","");$(ns.sev.css.tabKmeans).attr("class","")});$(ns.sev.css.tabStc).click(function(){ns.sev.resultSolrJSON=ns.sev.resultSolrClusteringStcJSON;$(ns.sev.css.tabLingo).attr("class","");$(ns.sev.css.tabStc).attr("class","active");$(ns.sev.css.tabKmeans).attr("class","")});$(ns.sev.css.tabKmeans).click(function(){ns.sev.resultSolrJSON=
ns.sev.resultSolrClusteringKmeansJSON;$(ns.sev.css.tabLingo).attr("class","");$(ns.sev.css.tabStc).attr("class","");$(ns.sev.css.tabKmeans).attr("class","active")})};
ns.sev.ajaxSolrClustering=function(){function b(){$.ajax({url:ns.sev.solr.query+"&"+ns.sev.solr.ClusteringEngineStc,dataType:"jsonp",jsonp:"json.wrf",success:function(a){ns.sev.resultSolrClusteringStcJSON=a;g()},error:function(a,b){console.log(a);console.log(b)}})}function g(){$.ajax({url:ns.sev.solr.query+"&"+ns.sev.solr.ClusteringEngineKmeans,dataType:"jsonp",jsonp:"json.wrf",success:function(a){ns.sev.resultSolrClusteringKmeansJSON=a},error:function(a,b){console.log(a);console.log(b)}})}$.ajax({url:ns.sev.solr.query+
"&"+ns.sev.solr.ClusteringEngineLingo,dataType:"jsonp",jsonp:"json.wrf",success:function(a){ns.sev.resultSolrJSON=a;ns.sev.afterAJAX();ns.sev.resultSolrClusteringLingoJSON=ns.sev.resultSolrJSON;b()},error:function(a,b){console.log(a);console.log(b)}})};ns.sev.setQueryStringBold=function(b,g){(new Hilitor(g)).apply(b)};
ns.sev.loadNextPageClient=function(b,g){null!=b&&b.preventDefault();var a="",d=ns.sev.currentPage*ns.sev.serpsPerPage,f=d+ns.sev.serpsPerPage;for(ns.sev.startRefresh();d<f&&void 0!==g.response.docs[d];d++)a+="<tr>",a+="<td>",a+="<h5>",a+="<span>"+g.response.docs[d].rank+" | </span>",a+="<a href='"+g.response.docs[d].url+"' target='_blank'> "+g.response.docs[d].title+" </a>",a+="</h5>",a+="<p class='text-success'>"+g.response.docs[d].displayUrl+"</p>",a+="<p>"+g.response.docs[d].description+"</p>",
a+="</td>",a+="</tr>";$("table.table").find("tr.loadNextRow").before(a);d<g.response.docs.length&&ns.sev.finishRefresh();ns.sev.currentPage++;ns.sev.setQueryStringBold(document.getElementById("input-query").value,"hilitor")};ns.sev.startRefresh=function(){$("#loadButton").css("display","none")};ns.sev.finishRefresh=function(){$("#loadButton").css("display","inline")};
ns.sev.getClusterTreeJSON=function(b){var g={name:"",children:[],docs:[],depth:"",tooltip:""};g.name=b.response.docs[0].query;g.docs=b.response.docs;g.depth=0;g.tooltip="query";b.clusters.forEach(function(a){var d={name:"",children:[],docs:[],depth:"",tooltip:""};d.name=a.labels.toString().replace(/,/g,", ");d.docs=a.docs;d.depth=1;d.tooltip="cluster";a.docs.forEach(function(a){var c={rank:"",title:"",description:"",displayUrl:"",url:"",query:"",depth:"",tooltip:""};c.rank=b.response.docs[a-1].rank;
c.title=b.response.docs[a-1].title;c.description=b.response.docs[a-1].description;c.displayUrl=b.response.docs[a-1].displayUrl;c.url=b.response.docs[a-1].url;c.query=b.response.docs[a-1].query;c.depth=2;c.tooltip="serp";d.children.push(c)});g.children.push(d)});return g};
ns.sev.drawD3Tree=function(b){function g(a){a.children&&(a._children=a.children,a._children.forEach(g),a.children=null)}function a(a){var b=p.nodes(h).reverse(),c=p.links(b);b.forEach(function(a){2>a.depth?a.y=a.depth*f*.3:a.y=a.depth*f*.2});var e=m.selectAll("g.node").data(b,function(a){return a.id||(a.id=++l)});e.enter().append("g").attr("class",function(a){return a.url?"node leaf":"node innerNode"}).attr("transform",function(b){return"translate("+a.y0+","+a.x0+")"}).on("click",d).append("circle").attr("r",
1E-6).style("stroke",function(a){if(a.rank)return a=(h.docs.length+1-a.rank)/h.docs.length,a=d3.hsl(120,a,.8).toString()}).style("stroke-width","1.5px");m.selectAll("g.leaf").append("a").attr("xlink:href",function(a){return a.url}).attr("target",function(a){return"_blank"}).append("text").attr("x",function(a){return a.children||a._children?-10:10}).attr("dy",".35em").attr("text-anchor",function(a){return a.children||a._children?"end":"start"}).style("fill-opacity",1E-6).text(function(a){return a.title}).on("click",
ns.sev.onClickFocusAhref).on("mouseover",ns.sev.mouseoverShowTooltip).on("mouseout",ns.sev.mouseoutHideTooltip);m.selectAll("g.innerNode").append("text").attr("x",function(a){return a.children||a._children?-10:10}).attr("dy",".35em").attr("text-anchor",function(a){return a.children||a._children?"end":"start"}).style("fill-opacity",1E-6).text(function(a){return a.name}).on("mouseover",ns.sev.mouseoverShowTooltip).on("mouseout",ns.sev.mouseoutHideTooltip);var g=e.transition().duration(500).attr("transform",
function(a){return"translate("+a.y+","+a.x+")"});g.select("circle").attr("r",4.5).style("fill",function(a){return a._children?"lightsteelblue":"#fff"});g.select("text").style("fill-opacity",1);e=e.exit().transition().duration(500).attr("transform",function(b){return"translate("+a.y+","+a.x+")"}).remove();e.select("circle").attr("r",1E-6);e.select("text").style("fill-opacity",1E-6);c=m.selectAll("path.link").data(c,function(a){return a.target.id});c.enter().insert("path","g").attr("class","link").attr("d",
function(b){b={x:a.x0,y:a.y0};return n({source:b,target:b})}).style("stroke",function(a){if(a.target.rank)return a=(h.docs.length+1-a.target.rank)/h.docs.length,a=d3.hsl(120,a,.8).toString()}).style("stroke-width","1.5px");c.transition().duration(500).attr("d",n);c.exit().transition().duration(500).attr("d",function(b){b={x:a.x,y:a.y};return n({source:b,target:b})}).remove();b.forEach(function(a){a.x0=a.x;a.y0=a.y})}function d(b){if(b.children){if(b._children=b.children,b.children=null,1==b.depth){var c=
{name:b.name,docs:b.docs};ns.sev.clusterPages(c,!1)}}else b.children=b._children,b._children=null,1==b.depth&&(c={name:b.name,docs:b.docs},ns.sev.clusterPages(c,!0));a(b)}var f=parseInt(d3.select("div.cluster").style("width"),10),c=.5*f,e=f-120-200,k=c-20-20,l=0,h=b;h.x0=k/2;h.y0=0;var p=d3.layout.tree().size([k,e]),n=d3.svg.diagonal().projection(function(a){return[a.y,a.x]}),m=d3.select("div#draw-tree").append("svg").style("width",f+"px").style("height",c+"px").append("g").attr("transform","translate(200,20)");
h.children.forEach(g);a(h)};
ns.sev.drawD3TreeRadial=function(b){var g=parseInt(d3.select("div.cluster").style("width"),10),a=.6*g,d=.3*a,f=d3.layout.tree().size([360,d]).separation(function(a,b){return(a.parent==b.parent?1:2)/a.depth}),c=d3.svg.diagonal.radial().projection(function(a){return[a.y,a.x/180*Math.PI]}),e=d3.select("div#draw-radial-tree").append("svg").attr("width",g).attr("height",a).append("g").attr("transform","translate("+g/2+","+a/2+")");(function(a){var b=f.nodes(a),h=f.links(b);e.selectAll(".link").data(h).enter().append("path").attr("class",
"link").attr("d",c).style("stroke",function(b){if(b.target.rank)return b=(a.docs.length+1-b.target.rank)/a.docs.length,b=d3.hsl(120,b,.8).toString()}).style("stroke-width","1.5px");e.selectAll(".node").data(b).enter().append("g").attr("class",function(a){return a.url?"node leaf":"node innerNode"}).attr("transform",function(a){return"rotate("+(a.x-90)+")translate("+a.y+")"}).append("circle").attr("r",4.5).style("stroke",function(b){if(b.rank)return b=(a.docs.length+1-b.rank)/a.docs.length,b=d3.hsl(120,
b,.8).toString()}).style("stroke-width","1.5px");e.selectAll("g.leaf").append("a").attr("xlink:href",function(a){return a.url}).attr("target",function(a){return"_blank"}).append("text").attr("dy",".31em").attr("text-anchor",function(a){return 180>a.x?"start":"end"}).attr("transform",function(a){return 180>a.x?"translate(8)":"rotate(180)translate(-8)"}).text(function(a){return ns.sev.truncateString(a.title,.7*d)}).on("click",ns.sev.onClickFocusAhref).on("mouseover",ns.sev.mouseoverShowTooltip).on("mouseout",
ns.sev.mouseoutHideTooltip);e.selectAll("g.innerNode").append("text").attr("dy",".31em").attr("text-anchor",function(a){return 180>a.x?"start":"end"}).attr("transform",function(a){return 180>a.x?"translate(8)":"rotate(180)translate(-8)"}).text(function(a){return ns.sev.truncateString(a.name,.5*d)}).on("mouseover",ns.sev.mouseoverShowTooltip).on("mouseout",ns.sev.mouseoutHideTooltip)})(b)};
ns.sev.getLinksNodesForceJSON=function(b){var g=[],a={},d={name:"",docs:"",links:[],nodes:{}},f={};d.name=b.response.docs[0].query;d.docs=b.response.docs;b.clusters.forEach(function(a){var b=a.labels.toString().replace(/,/g,", ");f[b]={name:b,docs:a.docs};a.docs.forEach(function(b){var c={source:"",target:""};c.source=a.labels.toString().replace(/,/g,", ");c.target=b;g.push(c)})});d.links=g;var c="",e="";g.forEach(function(d){c=d.source;void 0===a[c]?(a[c]={name:c},d.source=a[c],isNaN(c)?(a[c].docs=
f[c].docs,a[c].node="innerNode",a[c].tooltip="cluster"):(a[c].rank=b.response.docs[c-1].rank,a[c].title=b.response.docs[c-1].title,a[c].description=b.response.docs[c-1].description,a[c].displayUrl=b.response.docs[c-1].displayUrl,a[c].url=b.response.docs[c-1].url,a[c].query=b.response.docs[c-1].query,a[c].node="leaf",a[c].tooltip="serp")):d.source=a[c];e=d.target;void 0===a[e]?(a[e]={name:e},d.target=a[e],isNaN(e)?(a[e].docs=f[e].docs,a[e].node="innerNode",a[e].tooltip="cluster"):(a[e].rank=b.response.docs[e-
1].rank,a[e].title=b.response.docs[e-1].title,a[e].description=b.response.docs[e-1].description,a[e].displayUrl=b.response.docs[e-1].displayUrl,a[e].url=b.response.docs[e-1].url,a[e].query=b.response.docs[e-1].query,a[e].node="leaf",a[e].tooltip="serp")):d.target=a[e]});d.nodes=a;return d};
ns.sev.drawD3ForceGraph=function(b){function g(a){return Math.max(22,Math.min(d-22,a))}function a(a){return Math.max(22,Math.min(f-22,a))}var d=parseInt(d3.select("div.cluster").style("width"),10),f=.6*d,c=d3.layout.force().nodes(d3.values(b.nodes)).links(b.links).size([d,f]).on("tick",function(){l.attr("transform",function(b){return"translate("+g(b.x)+","+a(b.y)+")"});k.attr("x1",function(a){return g(a.source.x)}).attr("y1",function(b){return a(b.source.y)}).attr("x2",function(a){return g(a.target.x)}).attr("y2",
function(b){return a(b.target.y)})});c.friction(.6).charge(-1200).gravity(1).start();var e=d3.select("div#draw-force-graph").append("svg").attr("width",d).attr("height",f),k=e.selectAll(".link").data(c.links()).enter().append("line").attr("class","link").style("stroke","lightsteelblue").style("stroke-width","1.5px").style("stroke-opacity",.75),l=e.selectAll(".node").data(c.nodes()).enter().append("g").attr("class",function(a){return a.url?"node leaf":"node innerNode"}).on("mouseover.effect",ns.sev.mouseoverSetStyle).on("click",
ns.sev.onClickOpenURL).call(c.drag);l.append("circle").attr("r",function(a){return a.rank?12:18}).style("fill",function(a){return a.rank?(a=(b.docs.length+1-a.rank)/b.docs.length,d3.hsl(120,a,.8).toString()):"white"}).style("fill-opacity",function(a){return a.rank?.5:1}).style("stroke",function(a){return a.rank?null:"steelblue"}).style("stroke-width","2.5px").style("stroke-opacity",.5).on("mouseover.tooltip",ns.sev.mouseoverShowTooltip).on("mouseout.tooltip",ns.sev.mouseoutHideTooltip);l.append("text").attr("x",
0).attr("dy",".35em").style("fill-opacity",function(a){return a.rank?.25:1}).style("text-anchor","middle").text(function(a){return a.name}).on("mouseover.tooltip",ns.sev.mouseoverShowTooltip).on("mouseout.tooltip",ns.sev.mouseoutHideTooltip)};
ns.sev.drawD3ForceSearchGraph=function(b){function g(){m=e(h);q=d3.layout.tree().links(m);v.nodes(m).links(q).start();p=p.data(q,function(a){return a.target.id});p.exit().remove();p.enter().insert("line",".node").attr("class","link").attr("class","link").style("stroke","lightsteelblue").style("stroke-width","1.5px").style("stroke-opacity",.75);n=n.data(m,function(a){return a.id});n.exit().remove();var a=n.enter().append("g").attr("class","node").on("mouseover.style",ns.sev.mouseoverSetStyle).on("click.toggle",
c).on("click.url",ns.sev.onClickOpenURL).call(v.drag);a.append("circle").attr("r",function(a){return a.rank?12:18}).style("fill-opacity",function(a){return 0==a.depth?1:.5}).style("fill",function(a){return a.rank?d3.hsl(120,(h.docs.length+1-a.rank)/h.docs.length,.8).toString():a.children?"white":"lightsteelblue"}).style("stroke",function(a){return a.rank?null:"steelblue"}).style("stroke-width","2.5px").style("stroke-opacity",.5).on("mouseover.tooltip",ns.sev.mouseoverShowTooltip).on("mouseout.tooltip",
ns.sev.mouseoutHideTooltip);a.append("text").attr("x",0).attr("dy",".35em").style("fill-opacity",function(a){return a.rank?.25:1}).style("text-anchor","middle").text(function(a){return a.rank?a.rank:a.name}).on("mouseover.tooltip",ns.sev.mouseoverShowTooltip).on("mouseout.tooltip",ns.sev.mouseoutHideTooltip)}function a(b){b.children&&(b._children=b.children,b._children.forEach(a),b.children=null)}function d(a){return Math.max(22,Math.min(k-22,a))}function f(a){return Math.max(22,Math.min(l-22,a))}
function c(a){d3.event.defaultPrevented||a.url||(a.children?(a._children=a.children,a.children=null,1==a.depth&&(a={name:a.name,docs:a.docs},ns.sev.clusterPages(a,!1)),d3.select(this).select("circle").style("fill","lightsteelblue")):(a.children=a._children,a._children=null,1==a.depth&&(a={name:a.name,docs:a.docs},ns.sev.clusterPages(a,!0)),d3.select(this).select("circle").style("fill","white")),g())}function e(a){function b(a){a.children&&a.children.forEach(b);a.id||(a.id=++e);c.push(a)}var c=[],
e=0;b(a);return c}var k=parseInt(d3.select("div.cluster").style("width"),10),l=.6*k,h=b;b=d3.select("div#draw-force-search-graph").append("svg").attr("width",k).attr("height",l);var p=b.selectAll(".link"),n=b.selectAll(".node"),m=e(h),q=d3.layout.tree().links(m),v=d3.layout.force().size([k,l]).on("tick",function(){n.attr("transform",function(a){return"translate("+d(a.x)+","+f(a.y)+")"});p.attr("x1",function(a){return d(a.source.x)}).attr("y1",function(a){return f(a.source.y)}).attr("x2",function(a){return d(a.target.x)}).attr("y2",
function(a){return f(a.target.y)})});v.friction(.5).charge(-8E3).gravity(.5);v.nodes(m).links(q).start();h.children.forEach(a);g()};
ns.sev.getClusterNodesJSON=function(b){var g={name:"",nodes:[],clusters:[]},a=-1;g.name=b.response.docs[0].query;b.clusters.forEach(function(d){a++;var f={name:"",docs:[]};f.name=d.labels.toString().replace(/,/g,", ");f.docs=d.docs;g.clusters.push(f);d.docs.forEach(function(c){var e={clusterNode:!0,rank:"",title:"",description:"",displayUrl:"",url:"",query:"",depth:"",clusterName:"",clusterDocs:[],cluster:"",radius:"",color:"",tooltip:"cluster_serp"};e.rank=b.response.docs[c-1].rank;e.title=b.response.docs[c-
1].title;e.description=b.response.docs[c-1].description;e.displayUrl=b.response.docs[c-1].displayUrl;e.url=b.response.docs[c-1].url;e.query=b.response.docs[c-1].query;e.depth=2;e.clusterName=d.labels.toString().replace(/,/g,", ");e.clusterDocs=d.docs;e.cluster=a;c=e.rank;var f=b.response.docs.length;e.radius=20*Math.sqrt(.5*(c/f+1)*-Math.log(c/(f+20)));g.nodes.push(e)})});return g};
ns.sev.drawD3ForceClusterNodes=function(b){function g(a){return function(b){var c=e[b.cluster];if(c!==b){var d=b.x-c.x,f=b.y-c.y,g=Math.sqrt(d*d+f*f),h=b.radius+c.radius;g!=h&&(g=(g-h)/g*a,b.x-=d*=g,b.y-=f*=g,c.x+=d,c.y+=f)}}}function a(a){var b=d3.geom.quadtree(c);return function(c){var e=c.radius+20+Math.max(2,20),d=c.x-e,f=c.x+e,g=c.y-e,h=c.y+e;b.visit(function(b,e,l,n,k){if(b.point&&b.point!==c){var t=c.x-b.point.x,u=c.y-b.point.y,r=Math.sqrt(t*t+u*u),q=c.radius+b.point.radius+(c.cluster===b.point.cluster?
2:20);r<q&&(r=(r-q)/r*a,c.x-=t*=r,c.y-=u*=r,b.point.x+=t,b.point.y+=u)}return e>f||n<d||l>h||k<g})}}var d=parseInt(d3.select("div.cluster").style("width"),10),f=.6*d;d3.scale.category20().domain(d3.range(20));var c=b.nodes,e=[];b.nodes.forEach(function(a){a.rank==a.clusterDocs[0]&&e.push(a)});d3.layout.pack().sort(null).size([d,f]).children(function(a){return a.values}).value(function(a){return a.radius*a.radius}).nodes({values:d3.nest().key(function(a){return a.cluster}).entries(c)});var k=d3.layout.force().size([d,
f]).on("tick",function(b){h.each(g(10*b.alpha*b.alpha)).each(a(.5)).attr("transform",function(a){var b="translate("+Math.max(30,Math.min(d-30,a.x))+",";a=Math.max(30,Math.min(f-30,a.y));return b+a+")"})});k.charge(0).gravity(.02);k.nodes(c).start();var l=d3.select("div#draw-force-cluster-nodes").append("svg").attr("width",d).attr("height",f);l.style("opacity",1E-6).transition().duration(1E3).style("opacity",1);var h=l.selectAll(".node").data(c).enter().append("g").attr("class","node leaf").style("cursor",
"pointer").on("mouseover.effect",ns.sev.mouseoverSetStyle).on("mouseout.effect",ns.sev.mouseoutSetStyle).on("click",ns.sev.onClickOpenURL).call(k.drag);h.append("circle").attr("class","circle").attr("r",function(a){return a.radius}).style("fill",function(a){var c,e=1;c=360/b.clusters.length*a.cluster;a.cluster&1?e=.5:e=1;a.color=d3.hsl(c,e,.6).toString();30<c&&200>c?a.colorText="black":a.colorText="white";return a.color}).style("fill-opacity",.5).on("mouseover.tooltip",ns.sev.mouseoverShowTooltip).on("mouseout.tooltip",
ns.sev.mouseoutHideTooltip);h.append("text").attr("x",0).attr("dy",".35em").style("fill-opacity",.25).style("text-anchor","middle").text(function(a){return a.rank}).on("mouseover.tooltip",ns.sev.mouseoverShowTooltip).on("mouseout.tooltip",ns.sev.mouseoutHideTooltip)};
ns.sev.getFacetingJSON=function(b){var g={name:"",docs:[],facet:[],facetTags:[]};g.name=b.response.docs[0].query;b.response.docs.forEach(function(a){var b={rank:"",title:"",description:"",displayUrl:"",url:"",query:"",tooltip:"faceting"};b.rank=a.rank;b.title=a.title;b.description=a.description;b.displayUrl=a.displayUrl;b.url=a.url;b.query=a.query;g.docs.push(b)});var a="",d;b.facet_counts.facet_fields.text_facet.forEach(function(b){"string"==typeof b?a=b:(d=b,g.facet.push({name:a,docsNumber:d,tooltip:"faceting"}))});
var f;void 0!==b.responseHeader.params&&(f=b.responseHeader.params.fq);"string"==typeof f?g.facetTags.push(f):"object"==typeof f&&(g.facetTags=f.slice());return g};
ns.sev.drawD3WordCloud=function(b){function g(a){return 15+150*Math.log(1+a.docsNumber/e.facet[0].docsNumber)*(f/(f+2E3))}function a(){var a="";e.facetTags.forEach(function(b){a+="fq="+b+"&"});$.ajax({url:ns.sev.solr.url+"/select?q=*%3A*&"+a+"rows=100&df=text_facet&facet.mincount=1&"+ns.sev.solr.wt+"&"+ns.sev.solr.facet,dataType:"jsonp",jsonp:"json.wrf",success:function(a){ns.sev.resultSolrSelectJSON=a;$("div#word-cloud svg").remove();ns.sev.resultFacetingJSON=ns.sev.getFacetingJSON(ns.sev.resultSolrSelectJSON);
ns.sev.drawD3WordCloud(ns.sev.resultFacetingJSON);ns.sev.refreshSerps(ns.sev.resultSolrSelectJSON);d()},error:function(a,b){console.log(a);console.log(b)}})}function d(){var b=e.facetTags.length,c;c='<div id="faceting_tags" class="btn-toolbar">';for(var d=0;d<b;d++)c+='<div id="btn-group-'+e.facetTags[d]+'" class="btn-group btn-group-sm" style="margin-bottom: 10px">',c+='<button id="btn-'+e.facetTags[d]+'" class="btn btn-default" type="button">'+e.facetTags[d]+"</button>",c+='<button id="remove-'+
e.facetTags[d]+'" class="btn btn-danger" type="button" aria-label="remove">',c+='<i class="fa fa-times" aria-hidden="true"></i>',c+="</button>",c+="</div>";c+="</div>";$("div#draw-word-cloud").find("svg").before(c);e.facetTags.forEach(function(b){$("button#remove-"+b).click(function(c){e.facetTags=_.without(e.facetTags,b);a();$("div#btn-group-"+b).remove()});$("button#btn-"+b).click(function(c){e.facetTags=[b];a()});ns.sev.setQueryStringBold(document.getElementById("btn-"+b).textContent,"hilitor")})}
var f=parseInt(d3.select("div.cluster").style("width"),10),c=.2*f,e=b,k=d3.scale.category20();$("div#faceting_tags").remove();d3.layout.cloud().size([f,c]).words(e.facet).padding(2).rotate(function(){return 0}).font("Impact").fontSize(function(a){return g(a)}).text(function(a){return a.name}).on("end",function(b){d3.select("div#draw-word-cloud").append("svg").attr("width",f).attr("height",c).append("g").attr("transform","translate( "+f/2+","+c/2+")").selectAll("text").data(b).enter().append("text").style("font-size",
function(a){return g(a)+"px"}).style("font-family","Impact").style("fill",function(a,b){return k(b)}).style("cursor","pointer").attr("text-anchor","middle").attr("transform",function(a){return"translate("+[a.x,a.y]+")rotate("+a.rotate+")"}).text(function(a){return a.name}).on("mouseover.tooltip",ns.sev.mouseoverShowTooltip).on("mouseout.tooltip",ns.sev.mouseoutHideTooltip).on("click.tooltip",ns.sev.mouseoutHideTooltip).on("click.solr",function(b){e.facetTags.push(b.name);a()})}).start()};
ns.sev.mouseoverSetStyle=function(b){b.rank&&(d3.select(this).select("circle").style("fill-opacity",1),d3.select(this).select("text").style("fill-opacity",1))};ns.sev.mouseoutSetStyle=function(b){d3.select(this).select("circle").style("fill-opacity",.5);d3.select(this).select("text").style("fill-opacity",.25)};
ns.sev.onClickOpenURL=function(b){b.url&&!d3.event.defaultPrevented&&(window.open(b.url),d3.select(this).select("circle").style("stroke","steelblue").style("stroke-width","2.5px").style("stroke-opacity",1))};ns.sev.onClickFocusAhref=function(b){b.url&&d3.select(this).attr("style","fill: #23527c; text-decoration: underline")};
ns.sev.mouseoverShowTooltip=function(b,g){var a="";if("query"==b.tooltip)a+="<p>Search keyword: <span class='text-success'><strong>"+b.name+"</strong></span></p>";else if("cluster"==b.tooltip)a+="<h5>Category: <span class='text-success'><strong>"+b.name+"</strong></span></h5>",a+="<p><span class='text-success'><strong>"+b.docs.length+"</strong></span> result pages</p>";else if("serp"==b.tooltip)a=a+"<h5>"+("<span>"+b.rank+" | </span>"),a+="<a href=''> "+b.title+" </a>",a+="</h5>",a+="<p class='text-success'>"+
b.displayUrl+"</p>",a+="<p>"+b.description+"</p>";else if("cluster_serp"==b.tooltip)var d="style='background-color:"+b.color+"; text-align: center; color: "+b.colorText+";'",a=a+"<h5 style='text-align: center; margin-bottom: 5px;'>Category: ",a=a+("<span "+d+">&nbsp<strong>"+b.clusterName+"</strong>&nbsp</span>"),a=a+"</h5>",a=a+"<h5>",a=a+("<span>"+b.rank+" | </span>"),a=a+("<a href=''> "+b.title+" </a>"),a=a+"</h5>",a=a+("<p class='text-success'>"+b.displayUrl+"</p>"),a=a+("<p>"+b.description+"</p>");
else"faceting"==b.tooltip&&(a+="<h5>Keyword: <span class='text-success'><strong>"+b.name+"</strong></span></h5>",a+="<p>get <span class='text-success'><strong>"+b.docsNumber+"</strong></span> result pages</p>");$(this).tooltip({title:a,template:'<div class="tooltip" role="tooltip"><div id="ns-sev-tooltip" class="tooltip-inner"></div></div>',html:!0,container:"div#clusterTabContent",placement:"auto"}).tooltip("show");ns.sev.setQueryStringBold(document.getElementById("input-query").value,"ns-sev-tooltip")};
ns.sev.mouseoutHideTooltip=function(b,g){$(".tooltip").remove()};ns.sev.truncateString=function(b,g){for(var a=b.split(/\s+/).reverse(),d,f=[];d=a.pop();)if(f.push(d),8*f.join(" ").length>g){f.pop();f.push(" ...");break}return f.join(" ")};
ns.sev.responsiveD3=function(){function b(){d3.selectAll("svg").remove();"block"==$("div#tree").css("display")?(ns.sev.resultClusterTreeJSON=ns.sev.getClusterTreeJSON(ns.sev.resultSolrJSON),ns.sev.drawD3Tree(ns.sev.resultClusterTreeJSON)):"block"==$("div#radial-tree").css("display")?(ns.sev.resultClusterTreeJSON=ns.sev.getClusterTreeJSON(ns.sev.resultSolrJSON),ns.sev.drawD3TreeRadial(ns.sev.resultClusterTreeJSON)):"block"==$("div#force-graph").css("display")?(ns.sev.resultLinksNodesForceJSON=ns.sev.getLinksNodesForceJSON(ns.sev.resultSolrJSON),
ns.sev.drawD3ForceGraph(ns.sev.resultLinksNodesForceJSON)):"block"==$("div#force-search-graph").css("display")?(ns.sev.resultClusterTreeJSON=ns.sev.getClusterTreeJSON(ns.sev.resultSolrJSON),ns.sev.drawD3ForceSearchGraph(ns.sev.resultClusterTreeJSON)):"block"==$("div#force-cluster-nodes").css("display")?(ns.sev.resultClusterNodesJSON=ns.sev.getClusterNodesJSON(ns.sev.resultSolrJSON),ns.sev.drawD3ForceClusterNodes(ns.sev.resultClusterNodesJSON)):"block"==$("div#word-cloud").css("display")&&(ns.sev.resultFacetingJSON=
ns.sev.getFacetingJSON(ns.sev.resultSolrJSON),ns.sev.drawD3WordCloud(ns.sev.resultFacetingJSON));ns.sev.refreshSerps(ns.sev.resultSolrJSON)}var g;$(window).resize(function(){clearTimeout(g);g=setTimeout(b,500)})};
ns.sev.clusterPages=function(b,g){var a=ns.sev.resultSolrJSON;g?ns.sev.clusteredSerpList.push(b):ns.sev.clusteredSerpList.every(function(a,d,f){return a.name==b.name?(ns.sev.clusteredSerpList.splice(d,1),!1):!0});if(0==ns.sev.clusteredSerpList.length)ns.sev.refreshSerps(a);else{var d=[];ns.sev.clusteredSerpList.forEach(function(a){d=_.union(d,a.docs)});d.sort(function(a,b){return a-b});var f="";d.forEach(function(b){f+="<tr>";f+="<td>";f+="<h5>";f+="<span>"+a.response.docs[b-1].rank+" | </span>";
f+="<a href='"+a.response.docs[b-1].url+"' target='_blank'> "+a.response.docs[b-1].title+" </a>";f+="</h5>";f+="<p class='text-success'>"+a.response.docs[b-1].displayUrl+"</p>";f+="<p>"+a.response.docs[b-1].description+"</p>";f+="</td>";f+="</tr>"});$("tbody#hilitor tr").remove();$("table.table").find("tbody#hilitor").append(f);ns.sev.setQueryStringBold(document.getElementById("input-query").value,"hilitor")}};
ns.sev.refreshSerps=function(b){ns.sev.currentPage=1;ns.sev.serpsPerPage=10;ns.sev.clusteredSerpList=[];var g;b.response.docs.length>=ns.sev.serpsPerPage?g=ns.sev.serpsPerPage:g=b.response.docs.length;for(var a="",d=0;d<g;d++)a+="<tr>",a+="<td>",a+="<h5>",a+="<span>"+b.response.docs[d].rank+" | </span>",a+="<a href='"+b.response.docs[d].url+"' target='_blank'> "+b.response.docs[d].title+" </a>",a+="</h5>",a+="<p class='text-success'>"+b.response.docs[d].displayUrl+"</p>",a+="<p>"+b.response.docs[d].description+
"</p>",a+="</td>",a+="</tr>";b.response.docs.length>ns.sev.serpsPerPage&&g>=ns.sev.serpsPerPage&&(a+='<tr class="loadNextRow"><td colspan="2" class="loadNextColumn">',a+='<div style="text-align: center">',a+='<strong> <a id="loadButton">load next items</a></strong>',a+="</div>",a+="</td>",a+="</tr>");$("tbody#hilitor tr").remove();$("table.table").find("tbody#hilitor").append(a);ns.sev.setQueryStringBold(document.getElementById("input-query").value,"hilitor");$("#loadButton").click(function(a){ns.sev.loadNextPageClient(a,
b)})};